{"version":3,"sources":["../src/rendering.ts"],"names":["rendering","scope","elem","attrs","ctrl","StatusmapRenderer","grafanaTimeFormat","ticks","min","max","range","secPerTick","oneDay","oneYear","_","$","moment","kbn","appEvents","contextSrv","d3","d3ScaleChromatic","StatusmapTooltip","AnnotationTooltip","renderComplete","CoreEvents","PanelEvents","MIN_CARD_SIZE","CARD_H_SPACING","CARD_V_SPACING","CARD_ROUND","DATA_RANGE_WIDING_FACTOR","DEFAULT_X_TICK_SIZE_PX","DEFAULT_Y_TICK_SIZE_PX","X_AXIS_TICK_PADDING","Y_AXIS_TICK_PADDING","MIN_SELECTION_WIDTH","Statusmap","from","to","$heatmap","find","tooltip","annotationTooltip","yOffset","selection","active","x1","x2","padding","left","right","top","bottom","margin","events","on","render","onRender","bind","tickValueFormatter","graphHover","onGraphHover","graphHoverClear","onGraphHoverClear","onMouseDown","onMouseMove","onMouseLeave","onMouseClick","clearCrosshair","event","drawSharedCrosshair","pos","renderingCompleted","height","panel","row","isString","parseInt","replace","usingPagination","legend","show","css","e","axisText","selectAll","nodes","maxTextWidth","map","text","getBBox","width","Math","ceil","axisLine","select","empty","axisLinePosition","parseFloat","attr","canvasWidth","xScale","scaleTime","domain","timeRange","xGridSize","chartWidth","grafanaTimeFormatter","timeFormat","dashboardTimeZone","dashboard","getTimezone","utcFormat","xAxis","axisBottom","tickFormat","tickPadding","tickSize","chartHeight","posY","chartTop","posX","yAxisWidth","heatmap","append","call","remove","console","log","getPaginationSize","step","push","i","length","scaleOrdinal","ticksWhenPaginating","undefined","uniq","bucketMatrix","targets","yAxisSort","sort","a","b","localeCompare","ignorePunctuation","numeric","yAxisScale","getYAxisScale","yScale","getYScale","yAxis","axisLeft","tickValues","tickSizeInner","getYAxisWidth","tickInterval","y_widing","dataRangeWidingFactor","y_min","y_max","floor","decimals","scaledDecimals","format","value","valueFormats","heatmap_elem","insert","chartBottom","cardHSpacing","cards","cardVSpacing","cardRound","yGridSize","cardHeight","addYAxis","xBucketSize","cardWidth","addXAxis","xAxisHeight","getXAxisHeight","style","maxValue","color","minValue","mode","colorScale","getColorScale","setOpacityScale","data","enter","target","buckets","id","xid","yLabel","getCardX","getCardWidth","getCardY","getCardHeight","isEmpty","getCardColor","getCardOpacity","$cards","mouseOverBucket","highlightCard","resetCardHighLight","_renderAnnotations","emit","highlightColor","darker","strokeColor","brighter","current_card","originalFillColor","toString","colorScheme","colorSchemes","colorInterpolator","colorScaleInverted","invert","user","lightTheme","start","end","scaleSequential","opacityScale","scaleLinear","scalePow","exponent","x","rightX","relTo","rangeMs","cx","w","cutted_width","ys","y","h","bucket","cardColor","seriesFilterIndex","discreteExtraSeries","getBucketColorSingle","values","getBucketColor","nullPointMode","elemOffset","offset","clientX","clientY","getEventOffset","mouseUpHandler","onMouseUp","document","one","unbind","selectionRange","abs","timeFrom","timeTo","timeSrv","setTime","utc","clearSelection","destroy","limitSelection","offsetX","drawSelection","emitGraphHoverEvent","drawCrosshair","freezeOnClick","showFrozen","valueOf","pageX","pageY","y1","panelRelY","offsetY","posX1","posX2","selectionX","selectionWidth","position","graphTooltip","setElementHeight","cardsDataComplete","setFirstPageElement","getCurrentPage","elems","getTotalElements","getFirstPageElement","setCurrentPage","setLastPageElement","getNumberOfPages","cardsList","slice","cardsToShow","labelsToShow","cardsData","card","j","labelsToShowClean","Set","pageSize","addStatusmapCanvas","noDatapoints","addStatusmap","annotations","annoData","d","time","source","anno","iconColor","join","$ticks","mouseOverAnnotationTick"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport {appEvents, contextSrv} from 'app/core/core';\nimport * as d3 from 'd3';\nimport * as d3ScaleChromatic from './libs/d3-scale-chromatic/index';\nimport {StatusmapTooltip} from './tooltip';\nimport {AnnotationTooltip} from './annotations';\nimport { Bucket, BucketMatrix } from './statusmap_data';\nimport { StatusHeatmapCtrl, renderComplete } from './module';\nimport { CoreEvents, PanelEvents } from './libs/grafana/events/index';\n\nlet MIN_CARD_SIZE = 5,\n    CARD_H_SPACING = 2,\n    CARD_V_SPACING = 2,\n    CARD_ROUND = 0,\n    DATA_RANGE_WIDING_FACTOR = 1.2,\n    DEFAULT_X_TICK_SIZE_PX = 100,\n    DEFAULT_Y_TICK_SIZE_PX = 50,\n    X_AXIS_TICK_PADDING = 10,\n    Y_AXIS_TICK_PADDING = 5,\n    MIN_SELECTION_WIDTH = 2;\n\nexport default function rendering(scope: any, elem: any, attrs: any, ctrl: any) {\n  return new StatusmapRenderer(scope, elem, attrs, ctrl);\n}\n\nclass Statusmap {\n  $svg: any;\n  svg: any;\n  bucketMatrix: BucketMatrix;\n\n  timeRange: {from: number, to: number} = {from:0, to:0};\n\n  constructor() {\n\n  }\n}\n\nexport class StatusmapRenderer {\n  width: number = 0;\n  height: number = 0;\n  yScale: any;\n  xScale: any;\n  chartWidth: number = 0;\n  chartHeight: number = 0;\n  chartTop: number = 0;\n  chartBottom: number = 0;\n  yAxisWidth: number = 0;\n  xAxisHeight: number = 0;\n  cardVSpacing: number = 0;\n  cardHSpacing: number = 0;\n  cardRound: number = 0;\n  cardWidth: number = 0;\n  cardHeight: number = 0;\n  colorScale: any;\n  opacityScale: any;\n  mouseUpHandler: any;\n  xGridSize: number = 0;\n  yGridSize: number = 0;\n\n  bucketMatrix: BucketMatrix;\n  panel: any;\n  $heatmap: any;\n  tooltip: StatusmapTooltip;\n  annotationTooltip: AnnotationTooltip;\n  heatmap: any;\n  timeRange: any;\n\n  yOffset: number;\n  selection: any;\n  padding: any;\n  margin: any;\n  dataRangeWidingFactor: number = DATA_RANGE_WIDING_FACTOR;\n\n  constructor(private scope: any, private elem: any, attrs: any, private ctrl: StatusHeatmapCtrl) {\n    // $heatmap is JQuery object, but heatmap is D3\n    this.$heatmap = this.elem.find('.statusmap-panel');\n    this.tooltip = new StatusmapTooltip(this.$heatmap, this.scope);\n    this.annotationTooltip = new AnnotationTooltip(this.$heatmap, this.scope);\n\n    this.yOffset = 0;\n\n    this.selection = {\n      active: false,\n      x1: -1,\n      x2: -1,\n    };\n\n    this.padding = { left: 0, right: 0, top: 0, bottom: 0 };\n    this.margin = { left: 25, right: 15, top: 10, bottom: 20 };\n\n    this.ctrl.events.on(PanelEvents.render, this.onRender.bind(this));\n\n    this.ctrl.tickValueFormatter = this.tickValueFormatter.bind(this);\n\n    /////////////////////////////\n    // Selection and crosshair //\n    /////////////////////////////\n\n    // Shared crosshair and tooltip    this.empty = true;\n\n    appEvents.on( CoreEvents.graphHover, this.onGraphHover.bind(this), this.scope);\n\n    appEvents.on( CoreEvents.graphHoverClear, this.onGraphHoverClear.bind(this), this.scope);\n\n    // Register selection listeners\n    this.$heatmap.on('mousedown', this.onMouseDown.bind(this));\n    this.$heatmap.on('mousemove', this.onMouseMove.bind(this));\n    this.$heatmap.on('mouseleave', this.onMouseLeave.bind(this));\n    this.$heatmap.on('click', this.onMouseClick.bind(this));\n  }\n\n  onGraphHoverClear() {\n    this.clearCrosshair();\n  }\n\n  onGraphHover(event: { pos: any }) {\n    this.drawSharedCrosshair(event.pos);\n  }\n\n  onRender() {\n    this.render();\n    this.ctrl.renderingCompleted();\n  }\n\n\n  setElementHeight(): boolean {\n    try {\n      var height = this.ctrl.height || this.panel.height || this.ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      if (this.panel.usingPagination) {\n        height -= this.panel.legend.show ? 140 : 10; // bottom padding and space for legend. Change margin in .status-heatmap-color-legend !\n      } else {\n        height -= this.panel.legend.show ? 50 : 10; // bottom padding and space for legend. Change margin in .status-heatmap-color-legend !\n      }\n\n      this.$heatmap.css('height', height + 'px');\n\n      return true;\n    } catch (e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  getYAxisWidth(elem: any): number {\n    const axisText = elem.selectAll(\".axis-y text\").nodes();\n    const maxTextWidth = _.max(_.map(axisText, text => {\n      // Use SVG getBBox method\n      return text.getBBox().width;\n    }));\n\n    return Math.ceil(maxTextWidth);\n  }\n\n  getXAxisHeight(elem: any): number {\n    let axisLine = elem.select(\".axis-x line\");\n    if (!axisLine.empty()) {\n      let axisLinePosition = parseFloat(elem.select(\".axis-x line\").attr(\"y2\"));\n      let canvasWidth = parseFloat(elem.attr(\"height\"));\n      return canvasWidth - axisLinePosition;\n    } else {\n      // Default height\n      return 30;\n    }\n  }\n\n  addXAxis() {\n    // Scale timestamps to cards centers\n    //this.scope.xScale = this.xScale = d3.scaleTime()\n    //    .domain([this.timeRange.from, this.timeRange.to])\n    //    .range([this.xGridSize/2, this.chartWidth-this.xGridSize/2]);\n    // Buckets without the most recent\n    this.scope.xScale = this.xScale = d3.scaleTime()\n        .domain([this.timeRange.from, this.timeRange.to])\n        .range([this.xGridSize/2, this.chartWidth-this.xGridSize/2]);\n\n    let ticks = this.chartWidth / DEFAULT_X_TICK_SIZE_PX;\n    let grafanaTimeFormatter = grafanaTimeFormat(ticks, this.timeRange.from, this.timeRange.to);\n    let timeFormat;\n    let dashboardTimeZone = this.ctrl.dashboard.getTimezone();\n    if (dashboardTimeZone === 'utc') {\n      timeFormat = d3.utcFormat(grafanaTimeFormatter);\n    } else {\n      timeFormat = d3.timeFormat(grafanaTimeFormatter);\n    }\n\n    let xAxis = d3\n        .axisBottom(this.xScale)\n        .ticks(ticks)\n        .tickFormat(timeFormat)\n        .tickPadding(X_AXIS_TICK_PADDING)\n        .tickSize(this.chartHeight);\n\n    let posY = this.chartTop; // this.margin.top !\n    let posX = this.yAxisWidth;\n\n    this.heatmap.append(\"g\")\n        .attr(\"class\", \"axis axis-x\")\n        .attr(\"transform\", \"translate(\" + posX + \",\" + posY + \")\")\n        .call(xAxis);\n\n    // Remove horizontal line in the top of axis labels (called domain in d3)\n    this.heatmap\n        .select(\".axis-x\")\n        .select(\".domain\")\n        .remove();\n  }\n\n  // divide chart height by ticks for cards drawing\n  getYScale(ticks: any[]) {\n    let range:any[] = [];\n    //let step = this.chartHeight / ticks.length;\n    console.log('GETYSCALE - RENDERING', this.ctrl.getPaginationSize());\n    let step = this.chartHeight / this.ctrl.getPaginationSize();\n    // svg has y=0 on the top, so top card should have a minimal value in range\n    range.push(step);\n    for (let i = 1; i < ticks.length; i++) {\n      range.push(step * (i+1));\n    }\n    return d3.scaleOrdinal()\n        .domain(ticks)\n        .range(range);\n  }\n\n  // divide chart height by ticks with offset for ticks drawing\n  getYAxisScale(ticks: any[]) {\n    let range:any[] = [];\n    //let step = this.chartHeight / ticks.length;\n    console.log('GETYAXISSCALE - RENDERING', this.ctrl.getPaginationSize());\n    let step = this.chartHeight / this.ctrl.getPaginationSize();\n    // svg has y=0 on the top, so top tick should have a minimal value in range\n    range.push(this.yOffset);\n    for (let i = 1; i < ticks.length; i++) {\n      range.push(step * i + this.yOffset);\n    }\n    return d3.scaleOrdinal()\n        .domain(ticks)\n        .range(range);\n  }\n\n  addYAxis() {\n\n    let ticks;\n\n    if(this.ctrl.ticksWhenPaginating !== undefined && this.ctrl.panel.usingPagination) {\n      ticks = _.uniq(_.map(this.ctrl.ticksWhenPaginating));\n    } else {\n      ticks = this.bucketMatrix.targets;\n      //ticks = _.uniq(_.map(this.data, d => d.target));\n    }\n\n    // // Set default Y min and max if no data\n    // if (_.isEmpty(this.data)) {\n    //   ticks = [''];\n    // }\n    //\n    // // TODO\n    // // New version!\n    // let ticks = this.bucketMatrix.targets;\n\n\n    if (this.panel.yAxisSort == 'a → z') {\n      ticks.sort((a, b) => a.localeCompare(b, 'en', {ignorePunctuation: false, numeric: true}));\n    } else if (this.panel.yAxisSort == 'z → a') {\n      ticks.sort((b, a) => a.localeCompare(b, 'en', {ignorePunctuation: false, numeric: true}));\n    }\n\n    let yAxisScale = this.getYAxisScale(ticks);\n    this.scope.yScale = this.yScale = this.getYScale(ticks);\n\n    let yAxis = d3\n        .axisLeft(yAxisScale)\n        .tickValues(ticks)\n        .tickSizeInner(0 - this.width)\n        .tickPadding(Y_AXIS_TICK_PADDING);\n\n    this.heatmap\n        .append(\"g\")\n        .attr(\"class\", \"axis axis-y\")\n        .call(yAxis);\n\n    // Calculate Y axis width first, then move axis into visible area\n    let posY = this.margin.top;\n    let posX = this.getYAxisWidth(this.heatmap) + Y_AXIS_TICK_PADDING;\n    this.heatmap.select(\".axis-y\").attr(\"transform\", \"translate(\" + posX + \",\" + posY + \")\");\n\n    // Remove vertical line in the right of axis labels (called domain in d3)\n    this.heatmap.select(\".axis-y\").select(\".domain\").remove();\n    this.heatmap.select(\".axis-y\").selectAll(\".tick line\").remove();\n  }\n\n  // Wide Y values range and adjust to bucket size\n  wideYAxisRange(min: number, max: number, tickInterval: number) {\n    let y_widing = (max * (this.dataRangeWidingFactor - 1) - min * (this.dataRangeWidingFactor - 1)) / 2;\n    let y_min, y_max;\n\n    if (tickInterval === 0) {\n      y_max = max * this.dataRangeWidingFactor;\n      y_min = min - min * (this.dataRangeWidingFactor - 1);\n      tickInterval = (y_max - y_min) / 2;\n    } else {\n      y_max = Math.ceil((max + y_widing) / tickInterval) * tickInterval;\n      y_min = Math.floor((min - y_widing) / tickInterval) * tickInterval;\n    }\n\n    // Don't wide axis below 0 if all values are positive\n    if (min >= 0 && y_min < 0) {\n      y_min = 0;\n    }\n\n    return {y_min, y_max};\n  }\n\n  tickValueFormatter(decimals, scaledDecimals = null) {\n    let format = this.panel.yAxis.format;\n    return function(value) {\n      return kbn.valueFormats[format](value, decimals, scaledDecimals);\n    };\n  }\n\n  // Create svg element, add axes and\n  // calculate sizes for cards drawing\n  addStatusmapCanvas() {\n    let heatmap_elem = this.$heatmap[0];\n\n    this.width = Math.floor(this.$heatmap.width()) - this.padding.right;\n    this.height = Math.floor(this.$heatmap.height()) - this.padding.bottom;\n\n    if (this.heatmap) {\n      this.heatmap.remove();\n    }\n\n    // Insert svg as a first child into heatmap_elem\n    // as the frozen tooltip moving logiс assumes that tooltip is the last child.\n    this.heatmap = d3.select(heatmap_elem)\n        .insert(\"svg\",\":first-child\")\n        .attr(\"width\", this.width)\n        .attr(\"height\", this.height);\n\n    this.chartHeight = this.height - this.margin.top - this.margin.bottom;\n    this.chartTop = this.margin.top;\n    this.chartBottom = this.chartTop + this.chartHeight;\n\n    this.cardHSpacing = this.panel.cards.cardHSpacing !== null ? this.panel.cards.cardHSpacing : CARD_H_SPACING;\n    this.cardVSpacing = this.panel.cards.cardVSpacing !== null ? this.panel.cards.cardVSpacing : CARD_V_SPACING;\n    this.cardRound = this.panel.cards.cardRound !== null ? this.panel.cards.cardRound : CARD_ROUND;\n\n    // calculate yOffset for YAxis\n    this.yGridSize = this.chartHeight;\n    if (this.ctrl.panel.usingPagination) {\n      // Pagination mode overrides count of rows.\n      //this.yGridSize = Math.floor(this.chartHeight / this.ctrl.ticksWhenPaginating.length);\n      console.log('addHeatmapCanvas - rendering',this.ctrl.getPaginationSize());\n      this.yGridSize = Math.floor(this.chartHeight / this.ctrl.getPaginationSize());\n    } else {\n      if (this.bucketMatrix.targets.length > 0) {\n        this.yGridSize = Math.floor(this.chartHeight / this.bucketMatrix.targets.length);\n      }\n    }\n\n    this.cardHeight = this.yGridSize ? this.yGridSize - this.cardVSpacing : 0;\n    this.yOffset = this.cardHeight / 2;\n\n    this.addYAxis();\n\n    this.yAxisWidth = this.getYAxisWidth(this.heatmap) + Y_AXIS_TICK_PADDING;\n    this.chartWidth = this.width - this.yAxisWidth - this.margin.right;\n\n    // TODO allow per-y cardWidth!\n    // we need to fill chartWidth with xBucketSize cards.\n    this.xGridSize = this.chartWidth / (this.bucketMatrix.xBucketSize+1);\n    this.cardWidth = this.xGridSize - this.cardHSpacing;\n\n    this.addXAxis();\n    this.xAxisHeight = this.getXAxisHeight(this.heatmap);\n\n    if (!this.panel.yAxis.show) {\n      this.heatmap.select(\".axis-y\").selectAll(\"line\").style(\"opacity\", 0);\n    }\n\n    if (!this.panel.xAxis.show) {\n      this.heatmap.select(\".axis-x\").selectAll(\"line\").style(\"opacity\", 0);\n    }\n  }\n\n  addStatusmap():void {\n    let maxValue = this.panel.color.max || this.bucketMatrix.maxValue;\n    let minValue = this.panel.color.min || this.bucketMatrix.minValue;\n\n    if (this.panel.color.mode !== 'discrete') {\n      this.colorScale = this.getColorScale(maxValue, minValue);\n    }\n    this.setOpacityScale(maxValue);\n\n    // Draw cards from buckets.\n    this.heatmap.selectAll(\".statusmap-cards-row\").data(this.bucketMatrix.targets)\n      .enter()\n        .selectAll(\".statustmap-card\")\n        .data((target:string) => this.bucketMatrix.buckets[target])\n        .enter()\n          .append(\"rect\")\n          .attr(\"cardId\", (b:Bucket) => b.id)\n          .attr(\"xid\", (b:Bucket) => b.xid)\n          .attr(\"yid\", (b:Bucket) => b.yLabel)\n          .attr(\"x\", this.getCardX.bind(this))\n          .attr(\"width\", this.getCardWidth.bind(this))\n          .attr(\"y\", this.getCardY.bind(this))\n          .attr(\"height\", this.getCardHeight.bind(this))\n          .attr(\"rx\", this.cardRound)\n          .attr(\"ry\", this.cardRound)\n          .attr(\"class\", (b:Bucket) => b.isEmpty() ? \"empty-card\" : \"bordered statusmap-card\")\n          .style(\"fill\", this.getCardColor.bind(this))\n          .style(\"stroke\", this.getCardColor.bind(this))\n          .style(\"stroke-width\", 0)\n          //.style(\"stroke-width\", getCardStrokeWidth)\n          //.style(\"stroke-dasharray\", \"3,3\")\n          .style(\"opacity\", this.getCardOpacity.bind(this));\n\n    // Set mouse events on cards.\n    let $cards = this.$heatmap.find(\".statusmap-card + .bordered\");\n    $cards\n      .on(\"mouseenter\", (event) => {\n        this.tooltip.mouseOverBucket = true;\n        this.highlightCard(event);\n      })\n      .on(\"mouseleave\", (event) => {\n        this.tooltip.mouseOverBucket = false;\n        this.resetCardHighLight(event);\n      });\n\n    this._renderAnnotations();\n\n    this.ctrl.events.emit(renderComplete, {\n      \"chartWidth\": this.chartWidth\n    });\n  }\n\n  highlightCard(event) {\n    const color = d3.select(event.target).style(\"fill\");\n    const highlightColor = d3.color(color).darker(2);\n    const strokeColor = d3.color(color).brighter(4);\n    const current_card = d3.select(event.target);\n    this.tooltip.originalFillColor = color;\n    current_card\n        .style(\"fill\", highlightColor.toString())\n        .style(\"stroke\", strokeColor.toString())\n        .style(\"stroke-width\", 1);\n  }\n\n  resetCardHighLight(event) {\n    d3.select(event.target)\n      .style(\"fill\", this.tooltip.originalFillColor)\n      .style(\"stroke\", this.tooltip.originalFillColor)\n      .style(\"stroke-width\", 0);\n  }\n\n  getColorScale(maxValue, minValue = 0) {\n    let colorScheme = _.find(this.ctrl.colorSchemes, {value: this.panel.color.colorScheme});\n    let colorInterpolator = d3ScaleChromatic[colorScheme.value];\n    let colorScaleInverted = colorScheme.invert === 'always' ||\n        (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\n\n    if (maxValue == minValue)\n      maxValue = minValue + 1;\n\n    let start = colorScaleInverted ? maxValue : minValue;\n    let end = colorScaleInverted ? minValue : maxValue;\n\n    return d3.scaleSequential(colorInterpolator).domain([start, end]);\n  }\n\n  setOpacityScale(maxValue) {\n    if (this.panel.color.colorScale === 'linear') {\n      this.opacityScale = d3.scaleLinear()\n          .domain([0, maxValue])\n          .range([0, 1]);\n    } else if (this.panel.color.colorScale === 'sqrt') {\n      this.opacityScale = d3.scalePow().exponent(this.panel.color.exponent)\n          .domain([0, maxValue])\n          .range([0, 1]);\n    }\n  }\n\n  getCardX(b: Bucket) {\n    let x;\n    // cx is the center of the card. Card should be placed to the left.\n    //let cx = this.xScale(d.x);\n    let rightX = (b.relTo / this.bucketMatrix.rangeMs) * this.chartWidth;\n    let cx = rightX - this.cardWidth/2;\n\n    if (cx - this.cardWidth/2 < 0) {\n      x = this.yAxisWidth + this.cardHSpacing/2;\n    } else {\n      x = this.yAxisWidth + cx - this.cardWidth/2;\n    }\n\n    return x;\n  }\n\n  // xScale returns card center. Adjust cardWidth in case of overlaping.\n  getCardWidth(b: Bucket) {\n    //return 20;\n    let w;\n\n    let rightX = (b.relTo / this.bucketMatrix.rangeMs) * this.chartWidth;\n    let cx = rightX - this.cardWidth/2;\n    //let cx = this.xScale(d.x);\n\n    if (cx < this.cardWidth/2) {\n      // Center should not exceed half of card.\n      // Cut card to the left to prevent overlay of y axis.\n      let cutted_width = (cx - this.cardHSpacing/2) + this.cardWidth/2;\n      w = cutted_width > 0 ? cutted_width : 0;\n    } else if (this.chartWidth - cx < this.cardWidth/2) {\n      // Cut card to the right to prevent overlay of right graph edge.\n      w = this.cardWidth/2 + (this.chartWidth - cx - this.cardHSpacing/2);\n    } else {\n      w = this.cardWidth;\n    }\n\n    // Card width should be MIN_CARD_SIZE at least\n    w = Math.max(w, MIN_CARD_SIZE);\n\n    if (this.cardHSpacing == 0) {\n      w = w+1;\n    }\n\n    return w;\n  }\n\n  // Top y for card.\n  // yScale gives ???\n  getCardY(b: Bucket) {\n    return this.yScale(b.yLabel) + this.chartTop - this.cardHeight - this.cardVSpacing/2;\n  }\n\n  getCardHeight(b: Bucket) {\n    //return 20;\n    let ys = this.yScale(b.yLabel);\n    let y = ys + this.chartTop - this.cardHeight - this.cardVSpacing/2;\n    let h = this.cardHeight;\n\n    // Cut card height to prevent overlay\n    if (y < this.chartTop) {\n      h = ys - this.cardVSpacing/2;\n    } else if (ys > this.chartBottom) {\n      h = this.chartBottom - y;\n    } else if (y + this.cardHeight > this.chartBottom) {\n      h = this.chartBottom - y;\n    }\n\n    // Height can't be more than chart height\n    h = Math.min(h, this.chartHeight);\n    // Card height should be MIN_CARD_SIZE at least\n    h = Math.max(h, MIN_CARD_SIZE);\n\n    if (this.cardVSpacing == 0) {\n      h = h+1\n    }\n\n    return h;\n  }\n\n  getCardColor(bucket: Bucket) {\n    if (this.panel.color.mode === 'opacity') {\n      return this.panel.color.cardColor;\n    } else if (this.panel.color.mode === 'spectrum') {\n      return this.colorScale(bucket.value);\n    } else if (this.panel.color.mode === 'discrete') {\n      if (this.panel.seriesFilterIndex != null && this.panel.seriesFilterIndex != -1) {\n        return this.ctrl.discreteExtraSeries.getBucketColorSingle(bucket.values[this.panel.seriesFilterIndex]);\n      } else {\n        return this.ctrl.discreteExtraSeries.getBucketColor(bucket.values);\n      }\n    }\n  }\n\n  getCardOpacity(bucket: Bucket) {\n    if (this.panel.nullPointMode === 'as empty' && bucket.value == null ) {\n      return 0;\n    }\n    if (this.panel.color.mode === 'opacity') {\n      return this.opacityScale(bucket.value);\n    } else {\n      return 1;\n    }\n  }\n\n  getCardStrokeWidth(b: Bucket) {\n    if (this.panel.color.mode === 'discrete') {\n      return '1';\n    }\n    return '0';\n  }\n\n\n  /////////////////////////////\n  // Selection and crosshair //\n  /////////////////////////////\n\n  getEventOffset(event) {\n    const elemOffset = this.$heatmap.offset();\n    const x = Math.floor(event.clientX - elemOffset.left);\n    const y = Math.floor(event.clientY - elemOffset.top);\n    return { x, y };\n  }\n\n  onMouseDown(event) {\n    const offset = this.getEventOffset(event);\n    this.selection.active = true;\n    this.selection.x1 = offset.x;\n\n    this.mouseUpHandler = () => {\n      this.onMouseUp();\n    };\n\n    $(document).one(\"mouseup\", this.mouseUpHandler.bind(this));\n  }\n\n  onMouseUp() {\n    $(document).unbind(\"mouseup\", this.mouseUpHandler.bind(this));\n    this.mouseUpHandler = null;\n    this.selection.active = false;\n\n    let selectionRange = Math.abs(this.selection.x2 - this.selection.x1);\n    if (this.selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\n      let timeFrom = this.xScale.invert(Math.min(this.selection.x1, this.selection.x2) - this.yAxisWidth - this.xGridSize/2);\n      let timeTo = this.xScale.invert(Math.max(this.selection.x1, this.selection.x2) - this.yAxisWidth - this.xGridSize/2);\n\n      this.ctrl.timeSrv.setTime({\n        from: moment.utc(timeFrom),\n        to: moment.utc(timeTo)\n      });\n    }\n\n    this.clearSelection();\n  }\n\n  onMouseLeave(e) {\n    appEvents.emit(CoreEvents.graphHoverClear);\n    this.clearCrosshair();\n    this.annotationTooltip.destroy();\n  }\n\n  onMouseMove(event: MouseEvent) {\n    if (!this.heatmap) { return; }\n\n    const offset = this.getEventOffset(event);\n    if (this.selection.active) {\n      // Clear crosshair and tooltip\n      this.clearCrosshair();\n      this.tooltip.destroy();\n      this.annotationTooltip.destroy();\n\n      this.selection.x2 = this.limitSelection(event.offsetX);\n      this.drawSelection(this.selection.x1, this.selection.x2);\n    } else {\n      //const pos = this.getEventPos(event, offset);\n      this.emitGraphHoverEvent(event);\n      this.drawCrosshair(offset.x);\n      this.tooltip.show(event);\n      this.annotationTooltip.show(event);\n    }\n  }\n\n  // TODO emit an event and move logic to panelCtrl\n  public onMouseClick(e: MouseEvent) {\n    if (this.ctrl.panel.tooltip.freezeOnClick) {\n      this.tooltip.showFrozen(e);\n      this.tooltip.destroy();\n    }\n  }\n\n  getEventPos(event, offset) {\n    const x = this.xScale.invert(offset.x - this.yAxisWidth).valueOf();\n    const y = this.yScale.invert(offset.y - this.chartTop);\n    const pos = {\n      pageX: event.pageX,\n      pageY: event.pageY,\n      x: x,\n      x1: x,\n      y: y,\n      y1: y,\n      panelRelY: null,\n      offset,\n    };\n\n    return pos;\n  }\n\n  emitGraphHoverEvent(event) {\n    let x = this.xScale.invert(event.offsetX - this.yAxisWidth - this.xGridSize/2).valueOf();\n    let y = this.yScale(event.offsetY);\n    let pos = {\n      pageX: event.pageX,\n      pageY: event.pageY,\n      x: x, x1: x,\n      y: y, y1: y,\n      panelRelY: 0\n    };\n\n    // Set minimum offset to prevent showing legend from another panel\n    pos.panelRelY = Math.max(event.offsetY / this.height, 0.001);\n\n    // broadcast to other graph panels that we are hovering\n    appEvents.emit(CoreEvents.graphHover, {pos: pos, panel: this.panel});\n  }\n\n  limitSelection(x2) {\n    x2 = Math.max(x2, this.yAxisWidth);\n    x2 = Math.min(x2, this.chartWidth + this.yAxisWidth);\n    return x2;\n  }\n\n  drawSelection(posX1, posX2) {\n    if (this.heatmap) {\n      this.heatmap.selectAll(\".status-heatmap-selection\").remove();\n      let selectionX = Math.min(posX1, posX2);\n      let selectionWidth = Math.abs(posX1 - posX2);\n\n      if (selectionWidth > MIN_SELECTION_WIDTH) {\n        this.heatmap.append(\"rect\")\n        .attr(\"class\", \"status-heatmap-selection\")\n        .attr(\"x\", selectionX)\n        .attr(\"width\", selectionWidth)\n        .attr(\"y\", this.chartTop)\n        .attr(\"height\", this.chartHeight);\n      }\n    }\n  }\n\n  clearSelection() {\n    this.selection.x1 = -1;\n    this.selection.x2 = -1;\n\n    if (this.heatmap) {\n      this.heatmap.selectAll(\".status-heatmap-selection\").remove();\n    }\n  }\n\n\n  drawCrosshair(position) {\n    if (this.heatmap) {\n      this.heatmap.selectAll(\".status-heatmap-crosshair\").remove();\n\n      let posX = position;\n      posX = Math.max(posX, this.yAxisWidth);\n      posX = Math.min(posX, this.chartWidth + this.yAxisWidth);\n\n      this.heatmap.append(\"g\")\n        .attr(\"class\", \"status-heatmap-crosshair\")\n        .attr(\"transform\", \"translate(\" + posX + \",0)\")\n        .append(\"line\")\n        .attr(\"x1\", 1)\n        .attr(\"y1\", this.chartTop)\n        .attr(\"x2\", 1)\n        .attr(\"y2\", this.chartBottom)\n        .attr(\"stroke-width\", 1);\n    }\n  }\n\n  // map time to X\n  drawSharedCrosshair(pos) {\n    if (this.heatmap && this.ctrl.dashboard.graphTooltip !== 0) {\n      const posX = this.xScale(pos.x) + this.yAxisWidth;\n      this.drawCrosshair(posX);\n    }\n  }\n\n  clearCrosshair() {\n    if (this.heatmap) {\n      this.heatmap.selectAll(\".status-heatmap-crosshair\").remove();\n    }\n  }\n\n\n  render() {\n    this.panel = this.ctrl.panel;\n    this.timeRange = this.ctrl.range;\n    this.bucketMatrix = this.ctrl.bucketMatrix;\n\n    if (!this.bucketMatrix || !this.setElementHeight()) {\n      return;\n    } else {\n      // TODO pagination!\n      this.ctrl.cardsDataComplete = this.ctrl.bucketMatrix.buckets;\n\n      if(this.ctrl.panel.usingPagination) {\n        if (!this.bucketMatrix.targets) {\n          return;\n        }\n\n        this.ctrl.setFirstPageElement((this.ctrl.getCurrentPage()*this.ctrl.getPaginationSize())+1);\n\n        let elems = this.ctrl.getTotalElements();\n\n        console.log('total elems in add heatmap canvas', elems);\n        if (elems < this.ctrl.getFirstPageElement()) {\n          this.ctrl.setCurrentPage(0);\n          this.render();\n        }\n\n        if (this.ctrl.getPaginationSize() >= this.ctrl.getTotalElements()) {\n          this.ctrl.setLastPageElement(this.ctrl.getTotalElements());\n        } else {\n          if ((this.ctrl.getCurrentPage()+1) === this.ctrl.getNumberOfPages() && (this.ctrl.getCurrentPage()>0)) {\n            this.ctrl.setLastPageElement(this.ctrl.getTotalElements());\n          } else {\n            this.ctrl.setLastPageElement((this.ctrl.getCurrentPage() * this.ctrl.getPaginationSize())+this.ctrl.getPaginationSize());\n          }\n        }\n\n        let cardsList = this.ctrl.bucketMatrix.targets.slice(this.ctrl.getPaginationSize()*this.ctrl.getCurrentPage(),\n          (this.ctrl.getPaginationSize()*this.ctrl.getCurrentPage())+this.ctrl.getPaginationSize());\n\n        let cardsToShow = [];\n        let labelsToShow = [];\n\n        // Rewrite for bucket matrix.\n        for (let i = 0; i < this.cardsData.cards.length; i++) {\n          const card = this.cardsData.cards[i];\n\n          for (let j = 0; j < cardsList.length; j++) {\n            const value = cardsList[j];\n\n            if (card.y === value) {\n              cardsToShow.push(card);\n              labelsToShow.push(value);\n            }\n\n          }\n        }\n\n        const labelsToShowClean = [...new Set(labelsToShow)];\n\n        this.cardsData.cards = cardsToShow.slice();\n        this.ctrl.ticksWhenPaginating = labelsToShowClean;\n\n        cardsToShow = undefined;\n      } else {\n        const pageSize = this.ctrl.bucketMatrix.targets.length\n        this.ctrl.getPaginationSize(pageSize);\n        this.ctrl.ticksWhenPaginating = undefined;\n      }\n    }\n\n    // Draw default axes and return if no data\n    this.addStatusmapCanvas();\n    if (this.bucketMatrix.noDatapoints) {\n      return;\n    }\n\n    this.addStatusmap();\n    this.scope.yAxisWidth = this.yAxisWidth;\n    this.scope.xAxisHeight = this.xAxisHeight;\n    this.scope.chartHeight = this.chartHeight;\n    this.scope.chartWidth = this.chartWidth;\n    this.scope.chartTop = this.chartTop;\n\n    // TODO pagination. Why this needed?\n    //this.ctrl.cardsData.cards = this.ctrl.cardsDataComplete.slice();\n  }\n\n  _renderAnnotations() {\n    if (!this.ctrl.annotations || this.ctrl.annotations.length == 0) {\n      return;\n    }\n\n    if (!this.heatmap) {\n      return;\n    }\n\n\n\n    let annoData = _.map(this.ctrl.annotations, (d,i) => ({\"x\": Math.floor(this.yAxisWidth + this.xScale(d.time)), \"id\":i, \"anno\": d.source}));\n\n    //({\"ctrl_annotations\": this.ctrl.annotations, \"annoData\": annoData});\n\n    let anno = this.heatmap\n        .append(\"g\")\n        .attr(\"class\", \"statusmap-annotations\")\n        .attr(\"transform\", \"translate(0.5,0)\")\n        .selectAll(\".statusmap-annotations\")\n        .data(annoData)\n        .enter().append(\"g\")\n    ;\n    anno.append(\"line\")\n    //.attr(\"class\", \"statusmap-annotation-tick\")\n        .attr(\"x1\", d => d.x)\n        .attr(\"y1\", this.chartTop)\n        .attr(\"x2\", d => d.x)\n        .attr(\"y2\", this.chartBottom)\n        .style(\"stroke\", d => d.anno.iconColor)\n        .style(\"stroke-width\", 1)\n        .style(\"stroke-dasharray\", \"3,3\")\n    ;\n    anno.append(\"polygon\")\n        .attr(\"points\", d => [[d.x, this.chartBottom+1], [d.x-5, this.chartBottom+6], [d.x+5, this.chartBottom+6]].join(\" \"))\n        .style(\"stroke-width\", 0)\n        .style(\"fill\", d => d.anno.iconColor)\n    ;\n    // Polygons didn't fire mouseevents\n    anno.append(\"rect\")\n        .attr(\"x\", d => d.x-5)\n        .attr(\"width\", 10)\n        .attr(\"y\", this.chartBottom+1)\n        .attr(\"height\", 5)\n        .attr(\"class\", \"statusmap-annotation-tick\")\n        .attr(\"annoId\", d => d.id)\n        .style(\"opacity\", 0)\n    ;\n\n    let $ticks = this.$heatmap.find(\".statusmap-annotation-tick\");\n    $ticks\n      .on(\"mouseenter\", (event) => {\n        this.annotationTooltip.mouseOverAnnotationTick = true;\n      })\n      .on(\"mouseleave\", (event) => {\n        this.annotationTooltip.mouseOverAnnotationTick = false;\n      });\n  }\n}\n\nfunction grafanaTimeFormat(ticks, min, max) {\n  if (min && max && ticks) {\n    let range = max - min;\n    let secPerTick = (range/ticks) / 1000;\n    let oneDay = 86400000;\n    let oneYear = 31536000000;\n\n    if (secPerTick <= 45) {\n      return \"%H:%M:%S\";\n    }\n    if (secPerTick <= 7200 || range <= oneDay) {\n      return \"%H:%M\";\n    }\n    if (secPerTick <= 80000) {\n      return \"%m/%d %H:%M\";\n    }\n    if (secPerTick <= 2419200 || range <= oneYear) {\n      return \"%m/%d\";\n    }\n    return \"%Y-%m\";\n  }\n\n  return \"%H:%M\";\n}\n"],"file":"rendering.js"}